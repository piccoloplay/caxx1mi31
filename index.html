<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Speech to Text Chat Test</title>

<style>
  body {
    font-family: system-ui, sans-serif;
    background: #f4f4f4;
    margin: 0;
    display: flex;
    flex-direction: column;
    height: 100vh;
  }

  #topbar {
    background: white;
    padding: 10px 12px;
    border-bottom: 1px solid #ddd;
    display: flex;
    gap: 10px;
    align-items: center;
    justify-content: space-between;
  }

  #status {
    font-size: 14px;
    color: #333;
    opacity: 0.9;
  }

  #chat {
    flex: 1;
    padding: 16px;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .msg {
    max-width: 80%;
    padding: 10px 14px;
    border-radius: 12px;
    white-space: pre-wrap;
    word-wrap: break-word;
  }

  .user { background: #d1e7ff; align-self: flex-end; }
  .bot  { background: #e5e5e5; align-self: flex-start; }
  .sys  { background: #fff3cd; align-self: center; border: 1px solid #ffe69c; }

  #controls {
    display: flex;
    gap: 8px;
    padding: 10px;
    background: white;
    border-top: 1px solid #ddd;
  }

  input {
    flex: 1;
    padding: 10px;
    font-size: 16px;
  }

  button {
    padding: 10px 14px;
    font-size: 16px;
    cursor: pointer;
  }

  button:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }
</style>
</head>

<body>

<div id="topbar">
  <div id="status">Pronto.</div>
  <div style="font-size:12px;opacity:.7">Desktop: ok ‚Ä¢ Mobile: spesso limitato</div>
</div>

<div id="chat"></div>

<div id="controls">
  <input id="textInput" placeholder="Scrivi o parla..." />
  <button id="micBtn" title="Parla">üé§</button>
  <button id="sendBtn">Invia</button>
</div>

<script>
  const chat = document.getElementById("chat");
  const input = document.getElementById("textInput");
  const micBtn = document.getElementById("micBtn");
  const statusEl = document.getElementById("status");

  function setStatus(s) { statusEl.textContent = s; }

  function addMessage(text, cls) {
    const div = document.createElement("div");
    div.className = "msg " + cls;
    div.innerText = text;
    chat.appendChild(div);
    chat.scrollTop = chat.scrollHeight;
  }

  function sendMessage(text) {
    if (!text.trim()) return;
    addMessage(text, "user");
    input.value = "";
    setTimeout(() => addMessage("hello world", "bot"), 250);
  }

  document.getElementById("sendBtn").onclick = () => sendMessage(input.value);
  input.addEventListener("keydown", e => { if (e.key === "Enter") sendMessage(input.value); });

  // --- Support check Web Speech API ---
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  const hasWebSpeech = !!SpeechRecognition;

  // --- Optional fallback: record audio if Web Speech not available ---
  async function recordAudioFallback(seconds = 4) {
    setStatus("Web Speech non disponibile qui. Registro audio per test microfono‚Ä¶");
    addMessage("‚ö†Ô∏è Web Speech API non supportata su questo dispositivo/browser. Nessun STT possibile in solo HTML senza backend.", "sys");

    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    const chunks = [];
    const rec = new MediaRecorder(stream);

    rec.ondataavailable = e => { if (e.data.size > 0) chunks.push(e.data); };

    const stopped = new Promise(resolve => rec.onstop = resolve);
    rec.start();

    setTimeout(() => rec.stop(), seconds * 1000);
    await stopped;

    stream.getTracks().forEach(t => t.stop());

    const blob = new Blob(chunks, { type: rec.mimeType || "audio/webm" });
    const url = URL.createObjectURL(blob);

    addMessage("‚úÖ Microfono OK (audio registrato). Se vuoi posso aggiungere un bottone per scaricare l‚Äôaudio.", "sys");
    setStatus("Microfono testato. (Niente STT senza Web Speech o backend)");
    // Se vuoi anche un link visibile:
    // addMessage("Audio (test): " + url, "sys");
  }

  // --- Main mic action ---
  micBtn.onclick = async () => {
    micBtn.disabled = true;

    try {
      // 1) Forza richiesta permesso microfono (IMPORTANTISSIMO su mobile)
      setStatus("Richiedo permesso microfono‚Ä¶");
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      // Non ci serve lo stream qui per Web Speech, lo fermiamo subito
      stream.getTracks().forEach(t => t.stop());

      // 2) Se Web Speech c'√®, usa quello
      if (hasWebSpeech) {
        const recognition = new SpeechRecognition();
        recognition.lang = "it-IT";
        recognition.interimResults = false;
        recognition.continuous = false;

        recognition.onstart = () => { setStatus("In ascolto‚Ä¶ parla ora"); micBtn.textContent = "üéôÔ∏è"; };
        recognition.onend   = () => { setStatus("Pronto."); micBtn.textContent = "üé§"; micBtn.disabled = false; };

        recognition.onerror = (e) => {
          addMessage("‚ùå Errore Web Speech: " + (e.error || "unknown"), "sys");
          setStatus("Errore Web Speech. Riprova.");
          micBtn.textContent = "üé§";
          micBtn.disabled = false;
        };

        recognition.onresult = (e) => {
          const text = e.results?.[0]?.[0]?.transcript || "";
          if (text) sendMessage(text);
        };

        // Start STT
        recognition.start();
        return;
      }

      // 3) Se Web Speech NON c'√®, fallback: registra audio (solo test mic)
      await recordAudioFallback(4);
      micBtn.disabled = false;

    } catch (err) {
      const msg = (err && err.name) ? `${err.name}: ${err.message || ""}` : String(err);
      addMessage("‚ùå Permesso microfono negato o errore: " + msg, "sys");
      setStatus("Permesso microfono non disponibile.");
      micBtn.textContent = "üé§";
      micBtn.disabled = false;
    }
  };

  // Info iniziale
  if (!navigator.mediaDevices?.getUserMedia) {
    addMessage("‚ùå Questo browser non supporta getUserMedia (microfono).", "sys");
    setStatus("Browser non supportato.");
    micBtn.disabled = true;
  } else if (!hasWebSpeech) {
    addMessage("‚ÑπÔ∏è Web Speech API non disponibile qui. Il bottone üé§ chieder√† comunque il permesso mic e far√† un test registrazione.", "sys");
  } else {
    addMessage("‚ÑπÔ∏è Premi üé§ e parla: vedrai il testo in chat. Risposta sempre 'hello world'.", "sys");
  }
</script>

</body>
</html>
